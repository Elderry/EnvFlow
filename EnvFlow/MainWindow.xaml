<Window
    x:Class="EnvFlow.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:EnvFlow"
    mc:Ignorable="d"
    Title="EnvFlow - Environment Variable Editor">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <Grid Grid.Row="0" Background="{ThemeResource LayerFillColorDefaultBrush}" Padding="16,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE74C;" FontSize="20" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                <TextBlock Text="EnvFlow" FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <Button x:Name="RefreshButton" Click="RefreshButton_Click">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                        <TextBlock Text="Refresh"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Main Content Area with Two Panels -->
        <Grid Grid.Row="1" Padding="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel: User Environment Variables -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8,8,0,0"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE77B;" Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
                            <TextBlock Text="User Variables" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                            <Button Padding="8" 
                                    Click="AddUserVariableButton_Click"
                                    ToolTipService.ToolTip="Add new user variable">
                                <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            </Button>
                            <Button Padding="8" 
                                    Click="EditUserVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.CanEditUserVariable, Mode=OneWay}"
                                    ToolTipService.ToolTip="Edit selected variable">
                                <FontIcon Glyph="&#xE104;" FontSize="14"/>
                            </Button>
                            <Button Padding="8" 
                                    Click="DeleteUserVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.CanDeleteUserVariable, Mode=OneWay}"
                                    ToolTipService.ToolTip="Delete selected variable">
                                <FontIcon Glyph="&#xE107;" FontSize="14"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- TreeView -->
                <Border Grid.Row="1"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1,0,1,1"
                        CornerRadius="0,0,8,8">
                    <ScrollViewer>
                        <TreeView x:Name="UserEnvTreeView" 
                                  ItemsSource="{x:Bind ViewModel.UserVariables, Mode=OneWay}"
                                  SelectionChanged="UserEnvTreeView_SelectionChanged"
                                  Padding="12">
                            <TreeView.ItemTemplate>
                                <DataTemplate>
                                    <TreeViewItem ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="8" DoubleTapped="TreeViewItem_DoubleTapped">
                                            <FontIcon Glyph="{Binding Icon}" 
                                                      FontSize="16" 
                                                      Foreground="{Binding IconColor}"/>
                                            
                                            <TextBlock Text="{Binding DisplayName}" 
                                                       VerticalAlignment="Center"
                                                       MinWidth="150"/>
                                            
                                            <!-- Display Mode: Show value in gray -->
                                            <TextBlock Text="{Binding Value}" 
                                                       Foreground="Gray"
                                                       Margin="8,0,0,0"
                                                       VerticalAlignment="Center"
                                                       TextTrimming="CharacterEllipsis"
                                                       Visibility="{Binding ValueDisplayVisibility}"/>
                                            
                                            <!-- Edit Mode: Show TextBox -->
                                            <TextBox x:Name="EditTextBox"
                                                     Text="{Binding EditValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     Visibility="{Binding EditVisibility}"
                                                     MinWidth="300"
                                                     KeyDown="EditTextBox_KeyDown"
                                                     LostFocus="EditTextBox_LostFocus"
                                                     Loaded="EditTextBox_Loaded"/>
                                        </StackPanel>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Splitter -->
            <Border Grid.Column="1" Width="16" Padding="6,0">
                <Rectangle Fill="{ThemeResource DividerStrokeColorDefaultBrush}" Width="2"/>
            </Border>

            <!-- Right Panel: System Environment Variables -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8,8,0,0"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7F8;" Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                            <TextBlock x:Name="SystemVariablesTitle" 
                                       Text="System Variables" 
                                       FontWeight="SemiBold" 
                                       FontSize="16" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                            <Button x:Name="RestartAsAdminButton" 
                                    Click="RestartAsAdminButton_Click"
                                    ToolTipService.ToolTip="Restart with administrator privileges to edit system variables">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xEA18;" FontSize="14"/>
                                    <TextBlock Text="Restart as Admin"/>
                                </StackPanel>
                            </Button>
                            <Button Padding="8" 
                                    Click="AddSystemVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.IsAdmin, Mode=OneWay}"
                                    ToolTipService.ToolTip="Add new system variable (requires admin)">
                                <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            </Button>
                            <Button Padding="8" 
                                    Click="EditSystemVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.CanEditSystemVariable, Mode=OneWay}"
                                    ToolTipService.ToolTip="Edit selected variable (requires admin)">
                                <FontIcon Glyph="&#xE104;" FontSize="14"/>
                            </Button>
                            <Button Padding="8" 
                                    Click="DeleteSystemVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.CanDeleteSystemVariable, Mode=OneWay}"
                                    ToolTipService.ToolTip="Delete selected variable (requires admin)">
                                <FontIcon Glyph="&#xE107;" FontSize="14"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- TreeView -->
                <Border Grid.Row="1"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1,0,1,1"
                        CornerRadius="0,0,8,8">
                    <ScrollViewer>
                        <TreeView x:Name="SystemEnvTreeView" 
                                  ItemsSource="{x:Bind ViewModel.SystemVariables, Mode=OneWay}"
                                  SelectionChanged="SystemEnvTreeView_SelectionChanged"
                                  Padding="12">
                            <TreeView.ItemTemplate>
                                <DataTemplate>
                                    <TreeViewItem ItemsSource="{Binding Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="8" DoubleTapped="TreeViewItem_DoubleTapped">
                                            <FontIcon Glyph="{Binding Icon}" 
                                                      FontSize="16" 
                                                      Foreground="{Binding IconColor}"/>
                                            
                                            <TextBlock Text="{Binding DisplayName}" 
                                                       VerticalAlignment="Center"
                                                       MinWidth="150"/>
                                            
                                            <!-- Display Mode: Show value in gray -->
                                            <TextBlock Text="{Binding Value}" 
                                                       Foreground="Gray"
                                                       Margin="8,0,0,0"
                                                       VerticalAlignment="Center"
                                                       TextTrimming="CharacterEllipsis"
                                                       Visibility="{Binding ValueDisplayVisibility}"/>
                                            
                                            <!-- Edit Mode: Show TextBox -->
                                            <TextBox x:Name="EditTextBox"
                                                     Text="{Binding EditValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     Visibility="{Binding EditVisibility}"
                                                     MinWidth="300"
                                                     KeyDown="EditTextBox_KeyDown"
                                                     LostFocus="EditTextBox_LostFocus"
                                                     Loaded="EditTextBox_Loaded"/>
                                        </StackPanel>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </ScrollViewer>
                </Border>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" 
                Background="{ThemeResource LayerFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="StatusTextBlock"
                           Grid.Column="0" 
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                    <TextBlock x:Name="UserCountTextBlock" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock x:Name="SystemCountTextBlock" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
