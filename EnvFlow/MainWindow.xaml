<Window
    x:Class="EnvFlow.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:EnvFlow"
    xmlns:controls="using:EnvFlow.Controls"
    mc:Ignorable="d"
    Title="EnvFlow - Environment Variable Editor">

    <Grid Background="#F3F3F3">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Custom Title Bar -->
        <Grid x:Name="CustomTitleBar" Grid.Row="0" Background="#F3F3F3" Padding="16,8,150,8" Height="48">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                <FontIcon Glyph="&#xE74C;" FontSize="20" Foreground="{ThemeResource AccentFillColorDefaultBrush}"/>
                <TextBlock Text="EnvFlow" FontSize="20" FontWeight="SemiBold" VerticalAlignment="Center"/>
            </StackPanel>
        </Grid>

        <!-- Main Content Area with Two Panels -->
        <Grid Grid.Row="1" Padding="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Refresh Button Bar -->
            <Grid Grid.Row="0" Margin="0,-8,0,12">
                <Button x:Name="RefreshButton" Click="RefreshButton_Click" HorizontalAlignment="Right">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE72C;" FontSize="14"/>
                        <TextBlock Text="Refresh"/>
                    </StackPanel>
                </Button>
            </Grid>
            
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" MinWidth="300"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="3*" MinWidth="300"/>
                </Grid.ColumnDefinitions>

            <!-- Left Panel: User Environment Variables -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8,8,0,0"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE77B;" Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
                            <TextBlock Text="User Variables" FontWeight="SemiBold" FontSize="16" VerticalAlignment="Center"/>
                        </StackPanel>

                        <Button Grid.Column="1" 
                                Padding="8" 
                                Click="AddUserVariableButton_Click"
                                ToolTipService.ToolTip="Add new user variable">
                            <FontIcon Glyph="&#xE710;" FontSize="14"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- TreeView -->
                <Border Grid.Row="1"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1,0,1,1"
                        CornerRadius="0,0,8,8">
                    <ScrollViewer>
                        <TreeView x:Name="UserEnvTreeView" 
                                  ItemsSource="{x:Bind ViewModel.UserVariables, Mode=OneWay}"
                                  SelectionChanged="UserEnvTreeView_SelectionChanged"
                                  Padding="12">
                            <TreeView.ItemContainerStyle>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                            <TreeView.ItemTemplate>
                                <DataTemplate>
                                    <TreeViewItem ItemsSource="{Binding Children}" IsExpanded="{Binding IsExpanded, Mode=TwoWay}" PointerEntered="TreeItem_PointerEntered" PointerExited="TreeItem_PointerExited">
                                        <Grid HorizontalAlignment="Stretch">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" DoubleTapped="TreeViewItem_DoubleTapped">
                                                <FontIcon Glyph="{Binding Icon}" 
                                                          FontSize="16" 
                                                          Foreground="{Binding IconColor}"/>
                                            
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           VerticalAlignment="Center"
                                                           MinWidth="150"
                                                           Visibility="{Binding DisplayNameVisibility}"/>
                                            
                                                <!-- Display Mode: Show value in gray -->
                                                <TextBlock Text="{Binding Value}" 
                                                           Foreground="Gray"
                                                           Margin="8,0,0,0"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           Visibility="{Binding ValueDisplayVisibility}"/>
                                            
                                                <!-- Edit Mode: Show TextBox -->
                                                <TextBox x:Name="EditTextBox"
                                                         Text="{Binding EditValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         Visibility="{Binding EditVisibility}"
                                                         MinWidth="300"
                                                         KeyDown="EditTextBox_KeyDown"
                                                         LostFocus="EditTextBox_LostFocus"
                                                         Loaded="EditTextBox_Loaded"/>
                                            </StackPanel>
                                            
                                            <!-- Hover Buttons (Right-aligned) -->
                                            <StackPanel Grid.Column="1" x:Name="HoverButtons" Orientation="Horizontal" Spacing="4" Opacity="0" Margin="8,0,0,0" Visibility="{Binding HoverButtonsVisibility}">
                                                <!-- Add Child Button for composite variables -->
                                                <Button Padding="4" 
                                                        Click="AddChildButton_Click"
                                                        Visibility="{Binding AddChildButtonVisibility}"
                                                        ToolTipService.ToolTip="Add new path entry">
                                                    <FontIcon Glyph="&#xE710;" FontSize="12" Foreground="#107C10"/>
                                                </Button>
                                                
                                                <!-- Sort Button for composite variables -->
                                                <Button Padding="4" 
                                                        Click="SortButton_Click"
                                                        Visibility="{Binding NormalizeButtonVisibility}"
                                                        ToolTipService.ToolTip="Sort paths alphabetically">
                                                    <FontIcon Glyph="&#xE8CB;" FontSize="12" Foreground="#F7B32B"/>
                                                </Button>
                                                
                                                <Button Padding="4" 
                                                        Click="EditItemButton_Click"
                                                        Visibility="{Binding EditButtonVisibility}"
                                                        ToolTipService.ToolTip="Edit">
                                                    <FontIcon Glyph="&#xE104;" FontSize="12" Foreground="#0078D4"/>
                                                </Button>
                                                <Button Padding="4" 
                                                        Click="DeleteItemButton_Click"
                                                        ToolTipService.ToolTip="Delete">
                                                    <FontIcon Glyph="&#xE107;" FontSize="12" Foreground="#E81123"/>
                                                </Button>
                                                
                                                <!-- More Options Menu for composite variables -->
                                                <Button Padding="4"
                                                        x:Name="MoreOptionsButton"
                                                        Visibility="{Binding NormalizeButtonVisibility}"
                                                        ToolTipService.ToolTip="More options">
                                                    <FontIcon Glyph="&#xE712;" FontSize="12"/>
                                                    <Button.Flyout>
                                                        <MenuFlyout Opening="MenuFlyout_Opening" Closed="MenuFlyout_Closed">
                                                            <MenuFlyoutItem Text="Shrink paths" Click="ShrinkButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE73F;" Foreground="#8764B8"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                            <MenuFlyoutItem Text="Expand paths" Click="ExpandButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE740;" Foreground="#00B7C3"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                        </MenuFlyout>
                                                    </Button.Flyout>
                                                </Button>
                                                
                                                <!-- More Options Menu for non-composite variables -->
                                                <Button Padding="4"
                                                        Visibility="{Binding MoreOptionsVisibility}"
                                                        ToolTipService.ToolTip="More options">
                                                    <FontIcon Glyph="&#xE712;" FontSize="12"/>
                                                    <Button.Flyout>
                                                        <MenuFlyout Opening="MenuFlyout_Opening" Closed="MenuFlyout_Closed">
                                                            <MenuFlyoutItem Text="Shrink value" Click="ShrinkValueButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE73F;" Foreground="#8764B8"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                            <MenuFlyoutItem Text="Expand value" Click="ExpandValueButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE740;" Foreground="#00B7C3"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                        </MenuFlyout>
                                                    </Button.Flyout>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </ScrollViewer>
                </Border>
            </Grid>

            <!-- Splitter -->
            <controls:CursorGrid Grid.Column="1" 
                  Width="12" 
                  Background="Transparent"
                  x:Name="SplitterGrid"
                  PointerEntered="Splitter_PointerEntered"
                  PointerExited="Splitter_PointerExited"
                  PointerPressed="Splitter_PointerPressed"
                  PointerMoved="Splitter_PointerMoved"
                  PointerReleased="Splitter_PointerReleased">
                <Rectangle Fill="{ThemeResource DividerStrokeColorDefaultBrush}" 
                           Width="2"
                           HorizontalAlignment="Center"/>
            </controls:CursorGrid>

            <!-- Right Panel: System Environment Variables -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" 
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="8,8,0,0"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7F8;" Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                            <TextBlock x:Name="SystemVariablesTitle" 
                                       Text="System Variables" 
                                       FontWeight="SemiBold" 
                                       FontSize="16" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                            <Button x:Name="RestartAsAdminButton" 
                                    Click="RestartAsAdminButton_Click"
                                    ToolTipService.ToolTip="Restart with administrator privileges to edit system variables">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <FontIcon Glyph="&#xEA18;" FontSize="14"/>
                                    <TextBlock Text="Restart as Admin"/>
                                </StackPanel>
                            </Button>
                            <Button Padding="8" 
                                    Click="AddSystemVariableButton_Click"
                                    IsEnabled="{x:Bind ViewModel.IsAdmin, Mode=OneWay}"
                                    ToolTipService.ToolTip="Add new system variable (requires admin)">
                                <FontIcon Glyph="&#xE710;" FontSize="14"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- TreeView -->
                <Border Grid.Row="1"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1,0,1,1"
                        CornerRadius="0,0,8,8">
                    <ScrollViewer>
                        <TreeView x:Name="SystemEnvTreeView" 
                                  ItemsSource="{x:Bind ViewModel.SystemVariables, Mode=OneWay}"
                                  SelectionChanged="SystemEnvTreeView_SelectionChanged"
                                  Padding="12">
                            <TreeView.ItemContainerStyle>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                            <TreeView.ItemTemplate>
                                <DataTemplate>
                                    <TreeViewItem ItemsSource="{Binding Children}" IsExpanded="{Binding IsExpanded, Mode=TwoWay}" PointerEntered="TreeItem_PointerEntered" PointerExited="TreeItem_PointerExited">
                                        <Grid HorizontalAlignment="Stretch">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" DoubleTapped="TreeViewItem_DoubleTapped" Tag="System">
                                                <FontIcon Glyph="{Binding Icon}" 
                                                          FontSize="16" 
                                                          Foreground="{Binding IconColor}"/>
                                            
                                                <TextBlock Text="{Binding DisplayName}" 
                                                           VerticalAlignment="Center"
                                                           MinWidth="150"
                                                           Visibility="{Binding DisplayNameVisibility}"/>
                                            
                                                <!-- Display Mode: Show value in gray -->
                                                <TextBlock Text="{Binding Value}" 
                                                           Foreground="Gray"
                                                           Margin="8,0,0,0"
                                                           VerticalAlignment="Center"
                                                           TextTrimming="CharacterEllipsis"
                                                           Visibility="{Binding ValueDisplayVisibility}"/>
                                            
                                                <!-- Edit Mode: Show TextBox -->
                                                <TextBox x:Name="EditTextBox"
                                                         Text="{Binding EditValue, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                         Visibility="{Binding EditVisibility}"
                                                         MinWidth="300"
                                                         KeyDown="EditTextBox_KeyDown"
                                                         LostFocus="EditTextBox_LostFocus"
                                                         Loaded="EditTextBox_Loaded"/>
                                            </StackPanel>
                                            
                                            <!-- Hover Buttons (Right-aligned) -->
                                            <StackPanel Grid.Column="1" x:Name="HoverButtons" Orientation="Horizontal" Spacing="4" Opacity="0" Margin="8,0,0,0" Visibility="{Binding HoverButtonsVisibility}">
                                                <!-- Add Child Button for composite variables -->
                                                <Button Padding="4" 
                                                        Click="AddChildButton_Click"
                                                        Visibility="{Binding AddChildButtonVisibility}"
                                                        ToolTipService.ToolTip="Add new path entry">
                                                    <FontIcon Glyph="&#xE710;" FontSize="12" Foreground="#107C10"/>
                                                </Button>
                                                
                                                <!-- Sort Button for composite variables -->
                                                <Button Padding="4" 
                                                        Click="SortButton_Click"
                                                        Visibility="{Binding NormalizeButtonVisibility}"
                                                        ToolTipService.ToolTip="Sort paths alphabetically">
                                                    <FontIcon Glyph="&#xE8CB;" FontSize="12" Foreground="#F7B32B"/>
                                                </Button>
                                                
                                                <Button Padding="4" 
                                                        Click="EditItemButton_Click"
                                                        Visibility="{Binding EditButtonVisibility}"
                                                        ToolTipService.ToolTip="Edit">
                                                    <FontIcon Glyph="&#xE104;" FontSize="12" Foreground="#0078D4"/>
                                                </Button>
                                                <Button Padding="4" 
                                                        Click="DeleteItemButton_Click"
                                                        ToolTipService.ToolTip="Delete">
                                                    <FontIcon Glyph="&#xE107;" FontSize="12" Foreground="#E81123"/>
                                                </Button>
                                                
                                                <!-- More Options Menu for composite variables -->
                                                <Button Padding="4"
                                                        x:Name="MoreOptionsButton"
                                                        Visibility="{Binding NormalizeButtonVisibility}"
                                                        ToolTipService.ToolTip="More options">
                                                    <FontIcon Glyph="&#xE712;" FontSize="12"/>
                                                    <Button.Flyout>
                                                        <MenuFlyout Opening="MenuFlyout_Opening" Closed="MenuFlyout_Closed">
                                                            <MenuFlyoutItem Text="Shrink paths" Click="ShrinkButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE73F;" Foreground="#8764B8"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                            <MenuFlyoutItem Text="Expand paths" Click="ExpandButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE740;" Foreground="#00B7C3"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                        </MenuFlyout>
                                                    </Button.Flyout>
                                                </Button>
                                                
                                                <!-- More Options Menu for non-composite variables -->
                                                <Button Padding="4"
                                                        Visibility="{Binding MoreOptionsVisibility}"
                                                        ToolTipService.ToolTip="More options">
                                                    <FontIcon Glyph="&#xE712;" FontSize="12"/>
                                                    <Button.Flyout>
                                                        <MenuFlyout Opening="MenuFlyout_Opening" Closed="MenuFlyout_Closed">
                                                            <MenuFlyoutItem Text="Shrink value" Click="ShrinkValueButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE73F;" Foreground="#8764B8"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                            <MenuFlyoutItem Text="Expand value" Click="ExpandValueButton_Click">
                                                                <MenuFlyoutItem.Icon>
                                                                    <FontIcon Glyph="&#xE740;" Foreground="#00B7C3"/>
                                                                </MenuFlyoutItem.Icon>
                                                            </MenuFlyoutItem>
                                                        </MenuFlyout>
                                                    </Button.Flyout>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </ScrollViewer>
                </Border>
            </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" 
                Background="{ThemeResource LayerFillColorDefaultBrush}" 
                BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock x:Name="StatusTextBlock"
                           Grid.Column="0" 
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           VerticalAlignment="Center"/>

                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
                    <TextBlock x:Name="UserCountTextBlock" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock x:Name="SystemCountTextBlock" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
